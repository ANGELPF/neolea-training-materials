# How to quickly analyse a large set of pcap files with standard Unix tools

## Good practices

Network evidences like packet captures are at the root of a good analysis. If your evidences are partial or incorrect, you'll produce incorrect or partial analysis. The collection of network evidences is often underestimated and seen as a simple process.

Factors to check while performing a network capture:

- Time reference (is your system time synchronized? How can you fix a network packet capture using an incorrect time-stamp?)
- Is a passive network collection always passive? (e.g. are you doing name resolution? Do you have internet access from your network collection system? Can my network collection system be exploited?)
- Do you loose packets during the capture? (e.g. Using [netbeacon](https://www.github.com/adulau/netbeacon)? Do you have any statistics from your network packet capture device? (e.g. is there a day-night profile, how many packets do you have per second)
- Do you capture the correct size? (e.g. jumbo frame?)
- How large will be my packet capture? Should I have small file or large network capture files? Is my disk large enough to store the network capture? Is my disk fast enough to write capture files?
- Which format should I use to store my network capture? (pcap, pcap-ng?) This can lead to additional conversion before further analysis.

### Checking capture length

Before starting to analyse, a quick check of the capture length is required to know how large the capture payload is. This can be done by using the `file` unix command, to get the meta headers from pcap format.

~~~
chp-circlnet22-1-20191124174014.cap: tcpdump capture file (little-endian) - version 2.4 (Ethernet, capture length 65535)
chp-circlnet22-1-20191124184014.cap: tcpdump capture file (little-endian) - version 2.4 (Ethernet, capture length 65535)
chp-circlnet22-1-20191124194014.cap: tcpdump capture file (little-endian) - version 2.4 (Ethernet, capture length 65535)
~~~

In this case, the capture length is the maximum size and we can safely assume that the capture includes a complete datagram.

### Fixing time reference

It's not uncommon to receive network capture files where the capture system was not time synchronized. To recover the original time, you can dig into the capture to find additional elements like HTTP headers, NTP packets or other time references.

`editcap` -t can be used to adjust time difference. The value is expressed in seconds (with even the fractional seconds). `editcap` is part of the `wireshark` open source package.

If you know that you have 30 seconds of difference from a reference time, `editcap` can adjust the time in your network packet capture file:

~~~bash
editcap -t 30 original.pcap updated.pcap
~~~

WARNING: `editcap` will only change the time-stamp from the network capture header. Time information in the payload won't be updated (e.g. HTTP headers).

## How to quickly analyse large set of pcap files?

A common challenge in network forensic is to have a huge volume of small files generated by network capture software or interception devices. Manually dealing with such file is unrealistic and not giving a complete overview of all files. GNU parallel is a tool to allow parallel processing of multiple files/input and efficiently user processors available on a system (or multiple system as ssh can be used to do it remotely on multiple hosts).

~~~bash
ls -1 ../chp* | parallel 'tcpdump -n -r {1}'
...
14:20:10.201032 IP 58.124.254.223.25247 > 185.194.94.90.23: Flags [S], seq 3116523098, win 46966, length 0
14:20:10.201940 IP 184.105.247.246.44581 > 185.194.95.58.50070: Flags [S], seq 1448128517, win 65535, length 0
14:20:10.210079 IP 185.156.73.21.48924 > 185.194.95.207.24501: Flags [S], seq 2982368230, win 1024, length 0
14:20:10.246058 IP 122.228.19.79.52105 > 185.194.93.75.5800: Flags [S], seq 307148912, win 29200, options [mss 1460], length 0
14:20:10.276152 IP 159.65.11.106.61000 > 185.194.93.3.80: Flags [S], seq 1123543982, win 1024, length 0
14:20:10.286412 IP 185.156.73.21.48924 > 185.194.95.253.24501: Flags [S], seq 165640646, win 1024, length 0
14:20:10.301996 IP 185.143.223.185.49951 > 185.194.94.124.37125: Flags [S], seq 3502002096, win 1024, length 0
14:20:10.328887 IP 59.63.199.171.57223 > 185.194.95.28.1433: Flags [S], seq 1535406261, win 1024, length 0
14:20:10.381329 IP 88.247.117.206.35642 > 185.194.93.64.2323: Flags [S], seq 3116522816, win 21839, options [mss 1452], length 0
14:20:10.383067 IP 185.143.223.143.49661 > 185.194.92.171.7780: Flags [S], seq 3301581514, win 1024, length 0
14:20:10.389227 IP 51.83.138.91.41972 > 185.194.95.7.3388: Flags [S], seq 2854444645, win 1024, length 0
14:20:10.394970 IP 185.143.223.143.49661 > 185.194.93.114.8348: Flags [S], seq 328210579, win 1024, length 0
14:20:10.412678 IP 185.143.223.182.59252 > 185.194.95.252.35590: Flags [S], seq 1737934178, win 1024, length 0
14:20:10.413693 IP 92.246.76.194.49856 > 185.194.92.196.4004: Flags [S], seq 2975077804, win 1024, length 0
14:20:10.416709 IP 114.40.70.119.21923 > 185.194.92.93.23: Flags [S], seq 3116522589, win 15814, length 0
...
~~~


## Large dataset - sampling in Unix command line

It's not uncommon to have a very large dataset. If you want to sample to a certain number of lines, the `shuf` commands can help you. If you want a sample of 50000 elements, `shuf -n 50000` will do the job. We use it below to ensure a visual distribution of ISN numbers.

## How to generate a graph of all sampled ISN for TCP datagram?

~~~bash
ls -1 ../*.cap | parallel 'tshark -n -r {1} -T fields -e frame.time_epoch -T fields -e ip.src -T fields -e tcp.srcport -T fields -e ip.dst -T fields -e tcp.dstport -T fields -e tcp.seq -T fields -e tcp.flags -T fields -e ip.ttl -o tcp.relative_sequence_numbers:FALSE'| shuf -n 50000 |awk -e '{print $1"\t"$6}' | gnuplot -p -e 'set title "Honeypot/network telescope capture - TCP ISN - TCP port 26"; plot "/dev/stdin" using :2 with points pointtype 0'
~~~

## How to generate a graph of all ISN for a specific TCP port?

~~~bash
ls -1 ../*.cap | parallel 'tshark -n -r {1} -T fields -e frame.time_epoch -T fields -e ip.src -T fields -e tcp.srcport -T fields -e ip.dst -T fields -e tcp.dstport -T fields -e tcp.seq -T fields -e tcp.flags -T fields -e ip.ttl -o tcp.relative_sequence_numbers:FALSE -Y 'tcp.port==26' '| awk -e '{print $1"\t"$6}' | gnuplot -p -e 'set title "Honeypot/network telescope capture - TCP ISN - TCP port 26"; plot "/dev/stdin" using :2 with points pointtype 0'
~~~


